<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Karl Benedict">
  <title>Week 5 - Module 3 - GIS and Services Oriented Architectures</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <link rel="stylesheet" href="slides.css">
  <link rel="stylesheet" href="slide_specific.css">
</head>
<body>
<section class="title">
  <h1 class="title">Week 5 - Module 3 - GIS and Services Oriented Architectures</h1>
  <footer>
    <span class="author">Karl Benedict</span> · <span class="date">GEOG 485L/585L - Spring 2018</span>
  </footer>
</section>
<section class="slide level3">

<!---------------------------------------------------------------------------->
<!-- Week 05 ----------------------------------------------------------------->
<!-- Lecture 03 a 01 a ------------------------------------------------------->
<!-- GIS and Services Oriented Architectures---------------------------------->
<!---------------------------------------------------------------------------->
<!---------------------------------------------------------------------------->
</section>
<section id="overview" class="slide level3 module03a01a">
<h3>Overview</h3>
<ul>
<li>Geographic Information Systems
<ul>
<li>Data Types</li>
<li>Coordinate Systems</li>
</ul></li>
<li>Services Oriented Architectures
<ul>
<li>Historic Context</li>
<li>Current Model - Network Computing</li>
<li>Components</li>
<li>Interoperability Standards</li>
</ul></li>
</ul>
</section>
<section id="geographic-information-systems" class="title-slide slide level2 module03a01a"><h2>Geographic Information Systems</h2></section><section id="data-types---vector" class="slide level3 module03a01a">
<h3>Data Types - Vector</h3>
<ul>
<li>Vector data represent phenomena that are associated with specific bounded locations, typically represented by:
<ul>
<li>Points</li>
<li>Lines</li>
<li>Polygons</li>
</ul></li>
<li>Vector data include:
<ul>
<li>The geometries that describe the area being referenced, and</li>
<li>Attributes associated with that area</li>
</ul></li>
</ul>
<p>For example, a census vector data product might include the geometries that define census tracts and attributes associated with each geometry: population, income, etc.</p>
</section><section id="data-types---raster" class="slide level3 module03a01a">
<h3>Data Types - Raster</h3>
<ul>
<li><p>Raster data are frequently used to represent values for phenomena that vary continuously across space (e.g. elevation, concentration of air pollutants, depth to ground water, etc. )</p></li>
<li><p>These values are encoded over a regular grid of observation locations with a specified grid spacing - often referred to as the spatial resolution of the dataset (i.e. 10m resolution for a standard USGS Digital Elevation Model product)</p></li>
<li><p>Often parts of data collections that are repeated (i.e. remote sensing data products)</p></li>
</ul>
</section><section id="accessing-and-processing-raster-and-vector-data" class="slide level3">
<h3>Accessing and Processing Raster and Vector Data</h3>
<ul>
<li>ArcGIS - ArcCatalog</li>
<li>QGIS - Dataset properties available through the “Metadata” tab</li>
<li>Through metadata files available from the provider web site or embedded in the downloaded file</li>
</ul>
</section><section id="accessing-and-processing-raster-and-vector-data---programmatically" class="slide level3 module03a01a">
<h3>Accessing and Processing Raster and Vector Data - Programmatically</h3>
<ul>
<li>Two geospatial libraries and their related utility programs provide information about and tools for modifying vector and raster data sets</li>
</ul>
<dl>
<dt>OGR</dt>
<dd>vector data access and information
</dd>
<dt>GDAL</dt>
<dd>raster data access and information
</dd>
</dl>
<p>These libraries are the data access and processing foundation for a growing number of open source and commercial mapping systems</p>
<p>Information and documentation: <a href="http://gdal.org/">GDAL Home Page</a> | <a href="http://www.gdal.org/ogr/">OGR Home Page</a></p>
</section><section id="coordinate-systemsprojections" class="slide level3 module03a01a">
<h3>Coordinate Systems/Projections</h3>
<ul>
<li>To convert locations from a 3-dimensional oblate spherical coordinate system (such as is commonly used to represent the surface of the earth) to a 2-dimensional representation in a map, a coordinate transformation must be performed.</li>
<li>There are a limitless number of potential coordinate transformations possible, and a large number have been named and defined that meet specific cartographic or other requirements</li>
</ul>
</section><section id="epsg-codes" class="slide level3 module03a01a">
<h3>EPSG Codes</h3>
<ul>
<li><p>A catalog of numeric codes and associated coordinate transformation parameters is maintained by the International Association of Oil &amp; Gas Producers (OGP) - the successor scientific organization to the European Petroleum Survey Group (EPSG)</p></li>
<li><p>These numeric codes are used by many desktop and online mapping systems to document and represent the coordinate systems of available data and services</p></li>
<li><p>Links to an online version of the registry and downloadable databases of the registry are available from: <a href="http://www.epsg.org">http://www.epsg.org/Geodetic.html</a>.</p></li>
</ul>
</section><section id="projection-parameters" class="slide level3 module03a01a">
<h3>Projection Parameters</h3>
<p>The parameters that define a map projection may be looked up in a number of online locations:</p>
<dl>
<dt>EPSG registry</dt>
<dd>Helpful if you already know the EPSG code of the projection you are looking for - <a href="http://www.epsg-registry.org/" class="uri">http://www.epsg-registry.org/</a>
</dd>
<dt>GeoTIFF Projection List</dt>
<dd>Helpful if you know the name of one of the broadly used projections - uneven performance of links - <a href="http://web.archive.org/web/20160802172057/http://www.remotesensing.org/geotiff/proj_list/">http://www.remotesensing.org/geotiff/proj_list/ [Archived Version]</a>
</dd>
<dt>SpatialReference.org</dt>
<dd>Decent search tool, includes non-EPSG as well as EPSG projection information, multiple descriptions of projection parameters - <a href="http://spatialreference.org/" class="uri">http://spatialreference.org/</a>
</dd>
</dl>
</section>
<section id="services-oriented-architectures" class="title-slide slide level2 module03a01a"><h2>Services Oriented Architectures</h2></section><section id="where-have-we-come-from---eniac-1946" class="slide level3 module03a01a oneUp">
<h3>Where have we come from - ENIAC (1946)</h3>
<figure>
<img src="./images/Eniac.jpg" alt="ENIAC Computer" class="oneUp" /><figcaption>ENIAC Computer</figcaption>
</figure>
<ul>
<li>First general purpose electronic computer</li>
<li>Programmable, but could not store programs</li>
</ul>
</section><section id="where-have-we-come-from---early-client-server-computing-1960s" class="slide level3 module03a01a threeUp">
<h3>Where have we come from - Early Client-Server Computing (1960s)</h3>
<figure>
<img src="./images/IBM_704_mainframe.jpg" alt="IBM 704 Mainframe Computer" class="threeUp" /><figcaption>IBM 704 Mainframe Computer</figcaption>
</figure>
<figure>
<img src="./images/Model33_ASR_Teletype.jpg" alt="Model 33 ASR Teletype" class="threeUp" /><figcaption>Model 33 ASR Teletype</figcaption>
</figure>
<figure>
<img src="./images/279px-Televideo925Terminal.jpg" alt="TeleVideo 925 ASCII Terminal" class="threeUp" /><figcaption>TeleVideo 925 ASCII Terminal</figcaption>
</figure>
<ul>
<li>Mainframe computers to which client terminals connected over a local network</li>
<li>Computing performed by server, client purely a display device</li>
</ul>
</section><section id="where-have-we-come-from---personal-computers-1970s" class="slide level3 module03a01a twoUp">
<h3>Where have we come from - Personal Computers (1970s)</h3>
<figure>
<img src="./images/ibm_pc_5150.jpg" alt="IBM 5150 Personal Computer" class="twoUp" /><figcaption>IBM 5150 Personal Computer</figcaption>
</figure>
<figure>
<img src="./images/Apple_I_Computer.jpg" alt="Apple I Personal Computer" class="twoUp" /><figcaption>Apple I Personal Computer</figcaption>
</figure>
<ul>
<li>Desktop computers capable of running a variety of operating systems and applications</li>
<li>In some environments can be interconnected to a central local server</li>
</ul>
</section><section id="now---network-computing" class="slide level3 module03a01a oneUp">
<h3>Now - Network computing</h3>
<figure>
<img src="./images/hosts.png" alt="World Internet Hosts 1/94-1/13. Image courtesy IWS - http://www.isc.org/services/survey/" class="oneUP" /><figcaption>World Internet Hosts 1/94-1/13. Image courtesy <a href="http://www.isc.org/services/survey/">IWS - http://www.isc.org/services/survey/</a></figcaption>
</figure>
</section><section id="network-computing-timeline" class="slide level3 module03a01a">
<h3>Network Computing Timeline</h3>
<ul>
<li>Predecessor to the Internet - ARPANET (1969). Interconnection between UCLA and SRI (Menlo Park)</li>
<li>Adoption of TCP/IP as next generation protocol for ARPANET (1983)</li>
<li>NSF commissions construction of NSFNET, also based upon TCP/IP (1983)</li>
<li>NSFNET opened to commercial connections (1988). Led to interconnection of multiple, previously separate networks into an “Internet”</li>
<li>Growth of internet users has expanded rapidly over the past decade</li>
</ul>
</section><section id="in-a-phrase" class="slide level3 module03a01a">
<h3>In a Phrase …</h3>
<p>The current networking computing model consists of <em>Components Interacting</em> with Each Other</p>
</section><section id="so---we-need-to-answer-the-following-questions" class="slide level3 module03a01a">
<h3>So - We Need to Answer the Following Questions</h3>
<p>What are components?</p>
<p>What does it mean to interact?</p>
</section><section id="the-big-picture---services-oriented-architectures" class="slide level3 module03a01a floatLeft">
<h3>The Big Picture - Services Oriented Architectures</h3>
<figure>
<img src="./images/SOAillustration.png" alt="SOA Illustration" /><figcaption>SOA Illustration</figcaption>
</figure>
<ul>
<li>Services Oriented Architecture (SOA) for Geospatial Data and Processing
<ul>
<li>Data, Processing &amp; Client Tiers</li>
</ul></li>
<li>Open Geospatial Consortium Interoperability Standards
<ul>
<li>WMS, WFS, WCS</li>
</ul></li>
<li>Geospatial Metadata Standards
<ul>
<li>ISO 19115, FGDC</li>
</ul></li>
<li>Internet Standards
<ul>
<li>Web: HTML, CSS, JavaScript, XML</li>
<li>SOAP - Simple Object Access Protocol</li>
<li>REST - Representation State Transformation</li>
</ul></li>
</ul>
</section>
<section id="the-pieces---components" class="title-slide slide level2 module03a01a"><h2>The Pieces - Components</h2></section><section id="key-components---data" class="slide level3 module03a01a">
<h3>Key Components - Data</h3>
<p>Database systems</p>
<ul>
<li>Optimized for storing massive quantities of tabular data</li>
<li>May be spatially enabled to support the storage of geometries (points, lines, polygons) in addition to related attribute data</li>
<li>Standard language (Structured Query Language [SQL]) for interacting with many databases</li>
<li>Broad support for accessing the contents of databases from many other applications and programming languages, for example:
<ul>
<li>Spreadsheets</li>
<li>Statistical Software</li>
<li>Geographic Information Systems (GIS)</li>
</ul></li>
</ul>
</section><section id="key-components---data-1" class="slide level3 module03a01a">
<h3>Key Components - Data</h3>
<p>File-based data</p>
<ul>
<li>Often stored on the file system</li>
<li>Sometimes difficult represent data within a database structure (i.e. binary data)</li>
<li>May be in a wide variety of formats
<ul>
<li>XML</li>
<li>ASCII Text (e.g. CSV, tab-delimited)</li>
<li>Binary files</li>
<li>Excel Spreadsheets</li>
<li>Word Processing Documents</li>
<li>Geospatial data (e.g. imagery)</li>
</ul></li>
<li>Remotely Accessible Data
<ul>
<li>Some data may be provided through reference to an external network resource (i.e. a web address, or other identifier) or service</li>
</ul></li>
</ul>
</section><section id="key-components---processing-services" class="slide level3 module03a01a">
<h3>Key Components - Processing Services</h3>
<ul>
<li>Perform modification of source data to generate a new data product</li>
<li><p>May be “chained” together to create a processing “workflow”. Output from one processing service may be used as the input to another</p></li>
<li>May be simple OGC services; or complex data processing, analysis, or visualization services. Examples include
<ul>
<li>Extraction of a subset of a large data set based upon provided search criteria</li>
<li>Generation of a map from a collection of data</li>
<li>Fusion of two data products into a single derived product (e.g. vegetation indices calculated from multiple remote sensing images)</li>
<li>Calculation of statistical information for an input product, and delivery of the statistical summary</li>
</ul></li>
</ul>
</section><section id="key-components---clients" class="slide level3 module03a01a">
<h3>Key Components - Clients</h3>
<ul>
<li>Any system that accesses the services provided by the system may be considered a “client”</li>
<li>That system may be manually operated by a human user, or triggered automatically by software</li>
<li>Human operated clients include
<ul>
<li>Web-based applications</li>
<li>Desktop applications such as Geographic Information Systems and Statistical Analysis tools</li>
</ul></li>
<li>Machine clients include
<ul>
<li>Data processing services that translate requests to them into requests for other system services</li>
<li>Regularly scheduled requests that are automatically triggered by external computer systems.</li>
</ul></li>
</ul>
</section>
<section id="the-glue---interoperability-standards-service-interfaces" class="title-slide slide level2 module03a01a"><h2>The Glue - Interoperability Standards / Service Interfaces</h2></section>
<section id="open-geospatial-consortium-interoperability-standards" class="title-slide slide level2 module03a01a"><h2>Open Geospatial Consortium Interoperability Standards</h2></section><section id="open-geospatial-consortium-ogc-standards" class="slide level3 module03a01a">
<h3>Open Geospatial Consortium (OGC) Standards</h3>
<ul>
<li>Two Classes of Standards Considered Here
<ul>
<li>Geospatial Product Access Standards</li>
<li>Geospatial Data and Representation Standards</li>
</ul></li>
<li>Product Access Standards
<ul>
<li>Web Map Services (WMS)</li>
<li>Web Feature Services (WFS)</li>
<li>Web Coverage Services (WCS)</li>
</ul></li>
<li>Data and Representation Standards
<ul>
<li>Geography Markup Language (GML)</li>
<li>KML (formerly known as Keyhole Markup Language)</li>
</ul></li>
</ul>
</section><section id="comparison-of-ogc-service-models" class="slide level3 module03a01a center">
<h3>Comparison of OGC Service Models</h3>
<figure>
<img src="./images/ogcComparison.png" alt="Comparison of OGC Service Models" /><figcaption>Comparison of OGC Service Models</figcaption>
</figure>
</section><section id="ogc-web-map-services-wms" class="slide level3 module03a01a oneUp">
<h3>OGC Web Map Services (WMS)</h3>
<figure>
<img src="./images/wms_landsat_BernCo.jpeg" alt="WMS request result for Bernalillo County Landsat Mosaic from NM RGIS link" /><figcaption>WMS request result for Bernalillo County Landsat Mosaic from NM RGIS <a href="http://tinyurl.com/nue486n">link</a></figcaption>
</figure>
<div class="codeTable short">
<pre class="numberlines"><code>http://gstore.unm.edu/apps/rgis/datasets/
b030ab7b-86e3-4c30-91c0-f427303d5c77/
services/ogc/wms?
    VERSION=1.1.1&amp;&amp;
    SERVICE=WMS&amp;
    REQUEST=GetMap&amp;
    SRS=EPSG:4326&amp;
    FORMAT=image/jpeg&amp;
    STYLES=&amp;
    LAYERS=bernalillo_tm2011&amp;
    TRANSPARENT=TRUE&amp;
    WIDTH=521&amp;
    HEIGHT=200&amp;
    bbox=-107.207,34.8404,-106.143,35.2487</code></pre>
</div>
</section><section id="ogc-web-feature-services-wms-characteristics" class="slide level3 module03a01a">
<h3>OGC Web Feature Services (WMS) Characteristics</h3>
<ul>
<li>HTTP GET (required), HTTP POST (optional)</li>
<li>Requests:
<ul>
<li><code>GetCapabilities</code></li>
<li><code>GetMap</code></li>
<li><code>GetFeatureInfo</code></li>
</ul></li>
<li>Returns
<ul>
<li>Mapped data</li>
<li>XML Capabilities Document, Feature Attributes</li>
</ul></li>
<li>Includes support for time-based requests</li>
</ul>
</section><section id="ogc-web-feature-services-wfs-characteristics" class="slide level3 module03a01a">
<h3>OGC Web Feature Services (WFS) Characteristics</h3>
<ul>
<li>Either HTTP GET or POST required</li>
<li>Requests
<ul>
<li><code>GetCapabilities</code></li>
<li><code>DescribeFeatureType</code></li>
<li><code>GetFeature/GetFeatureWithLock</code></li>
<li><code>GetGmlObject</code></li>
<li><code>LockFeature</code></li>
<li><code>Transaction</code></li>
</ul></li>
<li>Returns
<ul>
<li>XML (GML)</li>
<li>Capabilities</li>
<li>Feature Data</li>
</ul></li>
</ul>
</section><section id="ogc-web-coverage-services-wcs-characteristics" class="slide level3 module03a01a">
<h3>OGC Web Coverage Services (WCS) Characteristics</h3>
<ul>
<li>Either HTTP GET or POST required</li>
<li>Requests
<ul>
<li><code>GetCapabilities</code></li>
<li><code>DescribeCoverage</code></li>
<li><code>GetCoverage</code></li>
</ul></li>
<li>Returns
<ul>
<li>Geospatial data for coverage</li>
<li>XML Capabilities</li>
</ul></li>
<li>Includes support for time-based requests</li>
</ul>
</section><section id="ogc-geography-markup-language-gml" class="slide level3 module03a01a">
<h3>OGC Geography Markup Language (GML)</h3>
<ul>
<li>GML is an XML grammar for representing geospatial features and their associated attributes</li>
<li>In its generic form it can encode points, lines, and polygons and their associated attributes</li>
<li>As an XML schema GML was designed to be extensible by communities of practice for consistent encoding of geographic data more richly than allowed by the generic default model</li>
<li>GML documents representing large complex geometries can be quite large - therefore slow to transfer over the Internet</li>
</ul>
</section><section id="ogc-kml" class="slide level3 module03a01a">
<h3>OGC KML</h3>
<ul>
<li>An XML specification that supports the encoding of representation and embedding of geospatial data for use in geospatial viewers</li>
<li>Began as the underlying representation language of Google Earth (originally developed by Keyhole for their virtual Earth viewer)</li>
<li>Adopted as an OGC standard in 2008</li>
<li>Supports data linkage through
<ul>
<li>Embedding</li>
<li>Reference through external URLs - with WMS specifically supported through <em>parameterization</em></li>
</ul></li>
<li>Includes support for the representation of time in relation to data objects</li>
</ul>
</section><section id="implementation-of-the-ogc-standards" class="slide level3 module03a01a twoColumn">
<h3>Implementation of the OGC Standards</h3>
<ul>
<li>WMS
<ul>
<li>1.3.0 - 389 implementations</li>
<li>1.1.1 - 558</li>
<li>1.1 - 263</li>
<li>1.0 - 301</li>
</ul></li>
<li>WFS
<ul>
<li>2.0 - 78</li>
<li>2.0 transactional - 17</li>
<li>1.1.0 - 310</li>
<li>1.1.0 transactional - 83</li>
<li>1.0.0 - 363</li>
<li>1.0.0 transactional - 131</li>
</ul></li>
<li>WCS
<ul>
<li>2.0 - Core - 7</li>
<li>1.1.2 - 27</li>
<li>1.1.1 Corregendum 1- 67</li>
<li>1.1.0 - 30</li>
<li>1.0.0 Corregendum - 227</li>
</ul></li>
<li>KML
<ul>
<li>2.2.0 - 117</li>
<li>2.2 Reference (Best Practice) - 11</li>
<li>2.1 Reference (Best Practice) - 82</li>
</ul></li>
<li>GML
<ul>
<li>3.3 - 6</li>
<li>3.2.1 - 157</li>
<li>3.1.1 - 161</li>
<li>3.0 - 156</li>
<li>2.1.2 - 179</li>
<li>2.1.1 - 127</li>
<li>2.0 - 82</li>
<li>1.0 - 20</li>
</ul></li>
</ul>
<p>Implementation information based upon <a href="http://www.opengeospatial.org/resource/products/stats">OGC Implementation Statistics</a> - Accessed 2/2017</p>
</section><section id="ogc-summary" class="slide level3 module03a01a">
<h3>OGC Summary</h3>
<p>The OGC web service specifications support key geospatial data access requirements</p>
<dl>
<dt>WMS</dt>
<dd>visualization of geospatial data through simple web requests
</dd>
<dt>WFS</dt>
<dd>delivery of geospatial data (typically points, lines, and polygons) in a format that is usable in GIS and other applications
</dd>
<dt>WCS</dt>
<dd>delivery of geospatial data (typically, but not limited to, raster data) usable in other applications
</dd>
</dl>
</section><section id="ogc-summary-1" class="slide level3 module03a01a">
<h3>OGC Summary</h3>
<p>The OGC data and representation standards support data exchange and higher level representation</p>
<dl>
<dt>GML</dt>
<dd>XML schema for the representation of features and associated attributes. It may be extended for use by specific communities of users (i.e. ecological data models)
</dd>
<dt>KML</dt>
<dd>XML schema that supports the combination of embedded data and external data into a complete representation model that may be used by client applications to present the data through a user interface (e.g. Google Earth, WorldWind)
</dd>
</dl>
</section>
<hr />
<section>
<div class="license">
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work by <span data-xmlns:cc="http://creativecommons.org/ns#" data-property="cc:attributionName">Karl Benedict</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
</div>
</section>
<!-- {{{{ dzslides core
#
#
#     __  __  __       .  __   ___  __
#    |  \  / /__` |    | |  \ |__  /__`
#    |__/ /_ .__/ |___ | |__/ |___ .__/ core :€
#
#
# The following block of code is not supposed to be edited.
# But if you want to change the behavior of these slides,
# feel free to hack it!
#
-->

<div id="progress-bar"></div>

<!-- Default Style -->
<style>
  * { margin: 0; padding: 0; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
  [role="note"] { display: none; }
  body {
    width: 800px; height: 600px;
    margin-left: -400px; margin-top: -300px;
    position: absolute; top: 50%; left: 50%;
    overflow: hidden;
    display: none;
  }
  .view body {
    position: static;
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    display: inline-block;
    overflow: visible; overflow-x: hidden;
    /* undo Dz.onresize */
    transform: none !important;
    -moz-transform: none !important;
    -webkit-transform: none !important;
    -o-transform: none !important;
    -ms-transform: none !important;
  }
  .view head, .view head > title { display: block }
  section {
    position: absolute;
    pointer-events: none;
    width: 100%; height: 100%;
  }
  .view section {
    pointer-events: auto;
    position: static;
    width: 800px; height: 600px;
    margin: -150px -200px;
    float: left;

    transform: scale(.4);
    -moz-transform: scale(.4);
    -webkit-transform: scale(.4);
    -o-transform: scale(.4);
    -ms-transform: scale(.4);
  }
  .view section > * { pointer-events: none; }
  section[aria-selected] { pointer-events: auto; }
  html { overflow: hidden; }
  html.view { overflow: visible; }
  body.loaded { display: block; }
  .incremental {visibility: hidden; }
  .incremental[active] {visibility: visible; }
  #progress-bar{
    bottom: 0;
    position: absolute;
    -moz-transition: width 400ms linear 0s;
    -webkit-transition: width 400ms linear 0s;
    -ms-transition: width 400ms linear 0s;
    transition: width 400ms linear 0s;
  }
  .view #progress-bar {
    display: none;
  }
</style>

<script>
  var Dz = {
    remoteWindows: [],
    idx: -1,
    step: 0,
    html: null,
    slides: null,
    progressBar : null,
    params: {
      autoplay: "1"
    }
  };

  Dz.init = function() {
    document.body.className = "loaded";
    this.slides = Array.prototype.slice.call($$("body > section"));
    this.progressBar = $("#progress-bar");
    this.html = document.body.parentNode;
    this.setupParams();
    this.onhashchange();
    this.setupTouchEvents();
    this.onresize();
    this.setupView();
  }

  Dz.setupParams = function() {
    var p = window.location.search.substr(1).split('&');
    p.forEach(function(e, i, a) {
      var keyVal = e.split('=');
      Dz.params[keyVal[0]] = decodeURIComponent(keyVal[1]);
    });
  // Specific params handling
    if (!+this.params.autoplay)
      $$.forEach($$("video"), function(v){ v.controls = true });
  }

  Dz.onkeydown = function(aEvent) {
    // Don't intercept keyboard shortcuts
    if (aEvent.altKey
      || aEvent.ctrlKey
      || aEvent.metaKey
      || aEvent.shiftKey) {
      return;
    }
    if ( aEvent.keyCode == 37 // left arrow
      || aEvent.keyCode == 38 // up arrow
      || aEvent.keyCode == 33 // page up
    ) {
      aEvent.preventDefault();
      this.back();
    }
    if ( aEvent.keyCode == 39 // right arrow
      || aEvent.keyCode == 40 // down arrow
      || aEvent.keyCode == 34 // page down
    ) {
      aEvent.preventDefault();
      this.forward();
    }
    if (aEvent.keyCode == 35) { // end
      aEvent.preventDefault();
      this.goEnd();
    }
    if (aEvent.keyCode == 36) { // home
      aEvent.preventDefault();
      this.goStart();
    }
    if (aEvent.keyCode == 32) { // space
      aEvent.preventDefault();
      this.toggleContent();
    }
    if (aEvent.keyCode == 70) { // f
      aEvent.preventDefault();
      this.goFullscreen();
    }
    if (aEvent.keyCode == 79) { // o
      aEvent.preventDefault();
      this.toggleView();
    }
  }

  /* Touch Events */

  Dz.setupTouchEvents = function() {
    var orgX, newX;
    var tracking = false;

    var db = document.body;
    db.addEventListener("touchstart", start.bind(this), false);
    db.addEventListener("touchmove", move.bind(this), false);

    function start(aEvent) {
      aEvent.preventDefault();
      tracking = true;
      orgX = aEvent.changedTouches[0].pageX;
    }

    function move(aEvent) {
      if (!tracking) return;
      newX = aEvent.changedTouches[0].pageX;
      if (orgX - newX > 100) {
        tracking = false;
        this.forward();
      } else {
        if (orgX - newX < -100) {
          tracking = false;
          this.back();
        }
      }
    }
  }

  Dz.setupView = function() {
    document.body.addEventListener("click", function ( e ) {
      if (!Dz.html.classList.contains("view")) return;
      if (!e.target || e.target.nodeName != "SECTION") return;

      Dz.html.classList.remove("view");
      Dz.setCursor(Dz.slides.indexOf(e.target) + 1);
    }, false);
  }

  /* Adapt the size of the slides to the window */

  Dz.onresize = function() {
    var db = document.body;
    var sx = db.clientWidth / window.innerWidth;
    var sy = db.clientHeight / window.innerHeight;
    var transform = "scale(" + (1/Math.max(sx, sy)) + ")";

    db.style.MozTransform = transform;
    db.style.WebkitTransform = transform;
    db.style.OTransform = transform;
    db.style.msTransform = transform;
    db.style.transform = transform;
  }


  Dz.getNotes = function(aIdx) {
    var s = $("section:nth-of-type(" + aIdx + ")");
    var d = s.$("[role='note']");
    return d ? d.innerHTML : "";
  }

  Dz.onmessage = function(aEvent) {
    var argv = aEvent.data.split(" "), argc = argv.length;
    argv.forEach(function(e, i, a) { a[i] = decodeURIComponent(e) });
    var win = aEvent.source;
    if (argv[0] === "REGISTER" && argc === 1) {
      this.remoteWindows.push(win);
      this.postMsg(win, "REGISTERED", document.title, this.slides.length);
      this.postMsg(win, "CURSOR", this.idx + "." + this.step);
      return;
    }
    if (argv[0] === "BACK" && argc === 1)
      this.back();
    if (argv[0] === "FORWARD" && argc === 1)
      this.forward();
    if (argv[0] === "START" && argc === 1)
      this.goStart();
    if (argv[0] === "END" && argc === 1)
      this.goEnd();
    if (argv[0] === "TOGGLE_CONTENT" && argc === 1)
      this.toggleContent();
    if (argv[0] === "SET_CURSOR" && argc === 2)
      window.location.hash = "#" + argv[1];
    if (argv[0] === "GET_CURSOR" && argc === 1)
      this.postMsg(win, "CURSOR", this.idx + "." + this.step);
    if (argv[0] === "GET_NOTES" && argc === 1)
      this.postMsg(win, "NOTES", this.getNotes(this.idx));
  }

  Dz.toggleContent = function() {
    // If a Video is present in this new slide, play it.
    // If a Video is present in the previous slide, stop it.
    var s = $("section[aria-selected]");
    if (s) {
      var video = s.$("video");
      if (video) {
        if (video.ended || video.paused) {
          video.play();
        } else {
          video.pause();
        }
      }
    }
  }

  Dz.setCursor = function(aIdx, aStep) {
    // If the user change the slide number in the URL bar, jump
    // to this slide.
    aStep = (aStep != 0 && typeof aStep !== "undefined") ? "." + aStep : ".0";
    window.location.hash = "#" + aIdx + aStep;
  }

  Dz.onhashchange = function() {
    var cursor = window.location.hash.split("#"),
        newidx = 1,
        newstep = 0;
    if (cursor.length == 2) {
      newidx = ~~cursor[1].split(".")[0];
      newstep = ~~cursor[1].split(".")[1];
      if (newstep > Dz.slides[newidx - 1].$$('.incremental > *').length) {
        newstep = 0;
        newidx++;
      }
    }
    this.setProgress(newidx, newstep);
    if (newidx != this.idx) {
      this.setSlide(newidx);
    }
    if (newstep != this.step) {
      this.setIncremental(newstep);
    }
    for (var i = 0; i < this.remoteWindows.length; i++) {
      this.postMsg(this.remoteWindows[i], "CURSOR", this.idx + "." + this.step);
    }
  }

  Dz.back = function() {
    if (this.idx == 1 && this.step == 0) {
      return;
    }
    if (this.step == 0) {
      this.setCursor(this.idx - 1,
                     this.slides[this.idx - 2].$$('.incremental > *').length);
    } else {
      this.setCursor(this.idx, this.step - 1);
    }
  }

  Dz.forward = function() {
    if (this.idx >= this.slides.length &&
        this.step >= this.slides[this.idx - 1].$$('.incremental > *').length) {
        return;
    }
    if (this.step >= this.slides[this.idx - 1].$$('.incremental > *').length) {
      this.setCursor(this.idx + 1, 0);
    } else {
      this.setCursor(this.idx, this.step + 1);
    }
  }

  Dz.goStart = function() {
    this.setCursor(1, 0);
  }

  Dz.goEnd = function() {
    var lastIdx = this.slides.length;
    var lastStep = this.slides[lastIdx - 1].$$('.incremental > *').length;
    this.setCursor(lastIdx, lastStep);
  }

  Dz.toggleView = function() {
    this.html.classList.toggle("view");

    if (this.html.classList.contains("view")) {
      $("section[aria-selected]").scrollIntoView(true);
    }
  }

  Dz.setSlide = function(aIdx) {
    this.idx = aIdx;
    var old = $("section[aria-selected]");
    var next = $("section:nth-of-type("+ this.idx +")");
    if (old) {
      old.removeAttribute("aria-selected");
      var video = old.$("video");
      if (video) {
        video.pause();
      }
    }
    if (next) {
      next.setAttribute("aria-selected", "true");
      if (this.html.classList.contains("view")) {
        next.scrollIntoView();
      }
      var video = next.$("video");
      if (video && !!+this.params.autoplay) {
        video.play();
      }
    } else {
      // That should not happen
      this.idx = -1;
      // console.warn("Slide doesn't exist.");
    }
  }

  Dz.setIncremental = function(aStep) {
    this.step = aStep;
    var old = this.slides[this.idx - 1].$('.incremental > *[aria-selected]');
    if (old) {
      old.removeAttribute('aria-selected');
    }
    var incrementals = $$('.incremental');
    if (this.step <= 0) {
      $$.forEach(incrementals, function(aNode) {
        aNode.removeAttribute('active');
      });
      return;
    }
    var next = this.slides[this.idx - 1].$$('.incremental > *')[this.step - 1];
    if (next) {
      next.setAttribute('aria-selected', true);
      next.parentNode.setAttribute('active', true);
      var found = false;
      $$.forEach(incrementals, function(aNode) {
        if (aNode != next.parentNode)
          if (found)
            aNode.removeAttribute('active');
          else
            aNode.setAttribute('active', true);
        else
          found = true;
      });
    } else {
      setCursor(this.idx, 0);
    }
    return next;
  }

  Dz.goFullscreen = function() {
    var html = $('html'),
        requestFullscreen = html.requestFullscreen || html.requestFullScreen || html.mozRequestFullScreen || html.webkitRequestFullScreen;
    if (requestFullscreen) {
      requestFullscreen.apply(html);
    }
  }
  
  Dz.setProgress = function(aIdx, aStep) {
    var slide = $("section:nth-of-type("+ aIdx +")");
    if (!slide)
      return;
    var steps = slide.$$('.incremental > *').length + 1,
        slideSize = 100 / (this.slides.length - 1),
        stepSize = slideSize / steps;
    this.progressBar.style.width = ((aIdx - 1) * slideSize + aStep * stepSize) + '%';
  }
  
  Dz.postMsg = function(aWin, aMsg) { // [arg0, [arg1...]]
    aMsg = [aMsg];
    for (var i = 2; i < arguments.length; i++)
      aMsg.push(encodeURIComponent(arguments[i]));
    aWin.postMessage(aMsg.join(" "), "*");
  }
  
  function init() {
    Dz.init();
    window.onkeydown = Dz.onkeydown.bind(Dz);
    window.onresize = Dz.onresize.bind(Dz);
    window.onhashchange = Dz.onhashchange.bind(Dz);
    window.onmessage = Dz.onmessage.bind(Dz);
  }

  window.onload = init;
</script>


<script> // Helpers
  if (!Function.prototype.bind) {
    Function.prototype.bind = function (oThis) {

      // closest thing possible to the ECMAScript 5 internal IsCallable
      // function 
      if (typeof this !== "function")
      throw new TypeError(
        "Function.prototype.bind - what is trying to be fBound is not callable"
      );

      var aArgs = Array.prototype.slice.call(arguments, 1),
          fToBind = this,
          fNOP = function () {},
          fBound = function () {
            return fToBind.apply( this instanceof fNOP ? this : oThis || window,
                   aArgs.concat(Array.prototype.slice.call(arguments)));
          };

      fNOP.prototype = this.prototype;
      fBound.prototype = new fNOP();

      return fBound;
    };
  }

  var $ = (HTMLElement.prototype.$ = function(aQuery) {
    return this.querySelector(aQuery);
  }).bind(document);

  var $$ = (HTMLElement.prototype.$$ = function(aQuery) {
    return this.querySelectorAll(aQuery);
  }).bind(document);

  $$.forEach = function(nodeList, fun) {
    Array.prototype.forEach.call(nodeList, fun);
  }

</script>
<!-- vim: set fdm=marker: }}} -->
</body>
</html>
